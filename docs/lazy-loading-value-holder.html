<!DOCTYPE html>
<html class="no-js" id="top">
<head>
    <title>ProxyManager</title>

    <meta name="description" content="A proxyManager write in php" />
    <meta name="keywords" content="ProxyManager, proxy, manager, ocramius, Marco Pivetta, php" />
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600' rel='stylesheet' type='text/css'>
    <link href="https://ocramius.github.io/ProxyManager/css/main.css" rel="stylesheet" />
    <link href="https://ocramius.github.io/ProxyManager/css/highlight.dark.css" rel="stylesheet" />
    <script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.3/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <link rel="shortcut icon" href="favicon.ico">
</head>
<body>

<header class="site-header">
<div class="container">
<h1><a href="https://ocramius.github.io/ProxyManager"><img alt="ProxyManager" src="https://ocramius.github.io/ProxyManager/img/block.png" /></a></h1>

<nav class="main-nav" role="navigation">
<ul>
    <li><a href="https://github.com/Ocramius/ProxyManager" target="_blank">Github</a></li>

    </ul>
    <div class="bcms-clearfix"></div>
</nav>
</div>
</header>
<main role="main">
<section class="component-content"><div class="page-title-wrapper">
<div class="container">
    <img src="https://github.com/Ocramius/ProxyManager/raw/master/proxy-manager.png">
    <h2 class="page-title">Proxy Manager</h2>
</div>
</div>

<div class="component-demo" id="live-demo">
    <div class="container">
            <div class="main-wrapper" style="text-align: right">
                <iframe src="http://ghbtns.com/github-btn.html?user=ocramius&amp;repo=ProxyManager&amp;type=fork&amp;count=true&amp;size=large"
  allowtransparency="true" frameborder="0" scrolling="0" width="310" height="40"></iframe>

                <iframe src="http://ghbtns.com/github-btn.html?user=ocramius&amp;repo=ProxyManager&amp;type=watch&amp;count=true&amp;size=large"
  allowtransparency="true" frameborder="0" scrolling="0" width="200" height="40"></iframe>

            </div>
        <div class="bcms-clearfix bcms-clearfix"></div>
    </div>
</div>
<div class="component-info">
<div class="container">

<aside class="sidebar">
    <nav class="spy-nav">
        <ul>
            <li><a href="https://ocramius.github.io/ProxyManager/index.html">Intro</a></li>
            <li><a href="https://ocramius.github.io/ProxyManager/docs/lazy-loading-value-holder.html">Virtual Proxy</a></li>
            <li><a href="https://ocramius.github.io/ProxyManager/docs/lazy-loading-ghost-object.html">Ghost Object</a></li>
            <li><a href="https://ocramius.github.io/ProxyManager/docs/access-interceptor-value-holder.html">Smart Reference</a></li>
            <li><a href="https://ocramius.github.io/ProxyManager/docs/access-interceptor-scope-localizer.html">Smart Reference<br/>(fluent safe)</a></li>
            <li><a href="https://ocramius.github.io/ProxyManager/docs/null-object.html">Null Objects</a></li>
            <li><a href="https://ocramius.github.io/ProxyManager/docs/remote-object.html">Remote Object</a></li>
            <li><a href="https://ocramius.github.io/ProxyManager/docs/generator-strategies.html">Code Evaluators</a></li>
            <li><a href="https://ocramius.github.io/ProxyManager/docs/tuning-for-production.md">Tuning for Production</a></li>
        </ul>
    </nav>
<div class="bcms-clearfix bcms-clearfix"></div>
<a class="btn btn-action btn-full download-component"
    href="https://ocramius.github.io/ProxyManager/docs/download.html">Download</a>
    <div class="bcms-clearfix"></div>
</aside>

<div class="content">
    
        <h1 id="lazy-loading-value-holder-proxy">Lazy Loading Value Holder Proxy</h1>
<p>A lazy loading value holder proxy is a virtual proxy that wraps and lazily initializes a &quot;real&quot; instance of the proxied
class.</p>
<h2 id="what-is-lazy-loading">What is lazy loading?</h2>
<p>In pseudo-code, in userland, <a href="http://www.martinfowler.com/eaaCatalog/lazyLoad.html">lazy loading</a> looks like following:</p>
<pre><code class="language-php">class MyObjectProxy
{
    private $wrapped;

    public function doFoo()
    {
        $this-&gt;init();

        return $this-&gt;wrapped-&gt;doFoo();
    }

    private function init()
    {
        if (null === $this-&gt;wrapped) {
            $this-&gt;wrapped = new MyObject();
        }
    }
}</code></pre>
<p>This code is problematic, and adds a lot of complexity that makes your unit tests' code even worse.</p>
<p>Also, this kind of usage often ends up in coupling your code with a particular
<a href="http://martinfowler.com/articles/injection.html">Dependency Injection Container</a>
or a framework that fetches dependencies for you.
That way, further complexity is introduced, and some problems related
with service location raise, as I've explained
<a href="http://ocramius.github.com/blog/zf2-and-symfony-service-proxies-with-doctrine-proxies/">in this article</a>.</p>
<p>Lazy loading value holders abstract this logic for you, hiding your complex, slow, performance-impacting objects behind
tiny wrappers that have their same API, and that get initialized at first usage.</p>
<h2 id="when-do-i-use-a-lazy-value-holder">When do I use a lazy value holder?</h2>
<p>You usually need a lazy value holder in cases where following applies</p>
<ul>
<li>your object takes a lot of time and memory to be initialized (with all dependencies)</li>
<li>your object is not always used, and the instantiation overhead can be avoided</li>
</ul>
<h2 id="usage-examples">Usage examples</h2>
<p><a href="https://github.com/Ocramius/ProxyManager">ProxyManager</a> provides a factory that eases instantiation of lazy loading
value holders. To use it, follow these steps:</p>
<p>First of all, define your object's logic without taking care of lazy loading:</p>
<pre><code class="language-php">namespace MyApp;

class HeavyComplexObject
{
    public function __construct()
    {
        // just write your business logic
        // don't worry about how heavy initialization of this will be!
    }

    public function doFoo() {
        echo 'OK!';
    }
}</code></pre>
<p>Then use the proxy manager to create a lazy version of the object (as a proxy):</p>
<pre><code class="language-php">namespace MyApp;

use ProxyManager\Factory\LazyLoadingValueHolderFactory;
use ProxyManager\Proxy\LazyLoadingInterface;

require_once __DIR__ . '/vendor/autoload.php';

$factory     = new LazyLoadingValueHolderFactory();
$initializer = function (&amp; $wrappedObject, LazyLoadingInterface $proxy, $method, array $parameters, &amp; $initializer) {
    $initializer   = null; // disable initialization
    $wrappedObject = new HeavyComplexObject(); // fill your object with values here

    return true; // confirm that initialization occurred correctly
};

$instance = $factory-&gt;createProxy('MyApp\HeavyComplexObject', $initializer);</code></pre>
<p>You can now simply use your object as before:</p>
<pre><code class="language-php">// this will just work as before
$proxy-&gt;doFoo(); // OK!</code></pre>
<h2 id="lazy-initialization">Lazy Initialization</h2>
<p>As you can see, we use a closure to handle lazy initialization of the proxy instance at runtime.
The initializer closure signature should be as following:</p>
<pre><code class="language-php">/**
 * @var object  $wrappedObject the instance (passed by reference) of the wrapped object,
 *                             set it to your real object
 * @var object  $proxy         the instance proxy that is being initialized
 * @var string  $method        the name of the method that triggered lazy initialization
 * @var string  $parameters    an ordered list of parameters passed to the method that
 *                             triggered initialization, indexed by parameter name
 * @var Closure $initializer   a reference to the property that is the initializer for the
 *                             proxy. Set it to null to disable further initialization
 *
 * @return bool true on success
 */
$initializer = function (&amp; $wrappedObject, $proxy, $method, $parameters, &amp; $initializer) {};</code></pre>
<p>The initializer closure should usually be coded like following:</p>
<pre><code class="language-php">$initializer = function (&amp; $wrappedObject, $proxy, $method, $parameters, &amp; $initializer) {
    $newlyCreatedObject = new Foo(); // instantiation logic
    $newlyCreatedObject-&gt;setBar('baz') // instantiation logic
    $newlyCreatedObject-&gt;setBat('bam') // instantiation logic

    $wrappedObject = $newlyCreatedObject; // set wrapped object in the proxy
    $initializer   = null; // disable initializer

    return true; // report success
};</code></pre>
<p>The
<a href="https://github.com/Ocramius/ProxyManager/blob/master/src/ProxyManager/Factory/LazyLoadingValueHolderFactory.php"><code>ProxyManager\Factory\LazyLoadingValueHolderFactory</code></a>
produces proxies that implement both the
<a href="https://github.com/Ocramius/ProxyManager/blob/master/src/ProxyManager/Proxy/ValueHolderInterface.php"><code>ProxyManager\Proxy\ValueHolderInterface</code></a>
and the
<a href="https://github.com/Ocramius/ProxyManager/blob/master/src/ProxyManager/Proxy/LazyLoadingInterface.php"><code>ProxyManager\Proxy\LazyLoadingInterface</code></a>.</p>
<p>At any point in time, you can set a new initializer for the proxy:</p>
<pre><code class="language-php">$proxy-&gt;setProxyInitializer($initializer);</code></pre>
<p>In your initializer, you currently <strong>MUST</strong> turn off any further initialization:</p>
<pre><code class="language-php">$proxy-&gt;setProxyInitializer(null);</code></pre>
<p>or</p>
<pre><code class="language-php">$initializer = null; // if you use the initializer by reference</code></pre>
<h2 id="triggering-initialization">Triggering Initialization</h2>
<p>A lazy loading proxy is initialized whenever you access any property or method of it.
Any of the following interactions would trigger lazy initialization:</p>
<pre><code class="language-php">// calling a method
$proxy-&gt;someMethod();

// reading a property
echo $proxy-&gt;someProperty;

// writing a property
$proxy-&gt;someProperty = 'foo';

// checking for existence of a property
isset($proxy-&gt;someProperty);

// removing a property
unset($proxy-&gt;someProperty);

// cloning the entire proxy
clone $proxy;

// serializing the proxy
$unserialized = serialize(unserialize($proxy));</code></pre>
<p>Remember to call <code>$proxy-&gt;setProxyInitializer(null);</code> to disable initialization of your proxy, or it will happen more
than once.</p>
<h2 id="proxying-interfaces">Proxying interfaces</h2>
<p>You can also generate proxies from an interface FQCN. By proxying an interface, you will only be able to access the
methods defined by the interface itself, even if the <code>wrappedObject</code> implements more methods. This will anyway save
some memory since the proxy won't contain useless inherited properties.</p>
<h2 id="tuning-performance-for-production">Tuning performance for production</h2>
<p>See <a href="tuning-for-production.html">Tuning ProxyManager for Production</a>.</p>

    </div>
</div>
</div>
</section>
</main>

    <footer class="site-footer" role="contentinfo">
        <div class="container">
            <div class="footer-logos">
                <ul>
                    <li><a href="https://ocramius.github.io/ProxyManager/docs/contributing.html">Contributing</a> | </li>
                    <li><a href="https://ocramius.github.io/ProxyManager/docs/credits.html">Credits</a> | </li>
                    <li><a href="https://ocramius.github.io/ProxyManager/docs/copyright.html">Copyright</a></li>
                </ul>
            </div>
        </div>

        <div class="bcms-clearfix"></div>
    </footer>
    <div class="bcms-clearfix"></div>
    </body>
</html>
